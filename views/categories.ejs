<%- include('partials/head', { title }) %>

<h1 class="text-2xl font-semibold mb-4">Categories</h1>

<div class="bg-white border rounded-lg p-4 mb-6">
  <h2 class="font-semibold mb-3">Add Category</h2>
  <div class="grid md:grid-cols-3 gap-3">
    <input id="name" class="input" placeholder="Name" />
    <input id="description" class="input md:col-span-2" placeholder="Description" />
  </div>
  <div class="mt-3"><button id="create" class="btn-primary">Create</button></div>
</div>

<div class="bg-white border rounded-lg">
  <table class="min-w-full">
    <thead class="bg-gray-100 text-sm">
      <tr>
        <th class="th">Name</th>
        <th class="th">Description</th>
        <th class="th">Actions</th>
      </tr>
    </thead>
    <tbody id="body" class="text-sm"></tbody>
  </table>
</div>

<script>
  const api = '/api/categories';
  const els = {
    name: document.getElementById('name'),
    description: document.getElementById('description'),
    create: document.getElementById('create'),
    body: document.getElementById('body')
  };

  async function load() {
    const rows = await fetch(api).then(r => r.json());
    els.body.innerHTML = rows.map(r => `
      <tr class="border-t">
        <td class="td"><input class="input" value="${r.name}" data-id="${r.id}" data-field="name" /></td>
        <td class="td"><input class="input" value="${r.description || ''}" data-id="${r.id}" data-field="description" /></td>
        <td class="td">
          <button class="btn" onclick="save(${r.id})">Save</button>
          <button class="btn-danger" onclick="del(${r.id})">Delete</button>
        </td>
      </tr>`).join('');
  }

  async function save(id) {
    const inputs = [...document.querySelectorAll(`[data-id='${id}']`)];
    const payload = {};
    inputs.forEach(i => payload[i.dataset.field] = i.value);
    const r = await fetch(`${api}/${id}`, {
      method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
    });
    if (!r.ok) alert('Save failed');
  }

  async function del(id) {
    if (!confirm('Delete category? This removes mappings too.')) return;
    const r = await fetch(`${api}/${id}`, { method: 'DELETE' });
    if (r.ok) load(); else alert('Delete failed');
  }

  els.create.onclick = async () => {
    const payload = { name: els.name.value, description: els.description.value };
    const r = await fetch(api, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
    if (r.ok) { els.name.value=''; els.description.value=''; load(); } else alert('Create failed');
  };

  load();
</script>

<%- include('partials/foot') %>